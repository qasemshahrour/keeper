---

- name: Check HTTPS Endpoint
  hosts: localhost
  gather_facts: false
  tasks:
              
    - name: Check endpoint
      uri:
        url: https://{{ item }}
        method: GET
        headers:
          Content-Type: "form-urlencoded"
          Connection: "keep-alive"
        return_content: false
        follow_redirects: all
        validate_certs: no
        force: true
        status_code: 200,500
      register: url_check
      #failed_when: true
      #changed_when: true
      #when: url_check != 200 and url_check != 500
      with_items:
        - www.ingotbrokers.com
        - www.ingotbrokers.com.jo
        - www.ingotbrokers.com.au
        - www.ingotbrokersafrica.com
        - www.ingotbrokersrsa.com
        - www.ingotbrokersllc.com
        - portal.ingotbrokers.com
        - portal.ingotbrokers.com.jo
        - portal.ingotbrokers.com.au
        - portal.ingotbrokersafrica.com
        - portal.ingotbrokersrsa.com
        - portal.ingotbrokersllc.com
   
    - name: Print Response
      debug:
        var: url_check.status

    - name: Failed When
      fail:
        msg: "url check status"
      when: url_check.status != 200

    - name: Failure Assert
      assert:
        that: url_check.failed
      register: assert_result

    - name: Send Email on Failure
      mail:
        host: "smtp.office365.com"
        port: "587"
        username: "ingotdmin@ingotbrokers.com"
        password: "Wax92237"
        to: "q.shahrour@ingotbrokers.com"
        body: "Website Checking Task has Failed on {{ item }}!!"
      when: assert_result.failed
