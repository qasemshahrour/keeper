- name: Install NPM
  tags: node
  async: 3600
  poll: 10
  shell:
    "npm install"
  args:
    chdir: "{{ dest_dir[1] }}"
  register: NPM_START

- name: Debug npm install command
  debug:
    msg: "{{ NPM_START.stdout_lines }}"

- name: Validate npm installation
  debug: msg="Installation of node Succes"

- name: PM2 Install
  become: true
  npm:
    name: pm2
    global: yes

- name: deply.sh
  tags: node,build
  async: 3600
  poll: 10
  shell:
    "sh deploy.sh"
  args:
    chdir: "{{ dest_dir[1] }}"
  register: NODE_START

- name: Start PM2
  command: pm2 start
  args:
    chdir: "{{ dest_dir[1] ))"
  register: PM2_START

- name: Validating the port is open
  tags: node_validate,node
  wait_for:
    host: "localhost"
    port: "3000"
    delay: "10"
    timeout: "30"
    state: started
